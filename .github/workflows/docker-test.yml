name: Test Docker Builds

on:
  pull_request:
    branches:
      - main

jobs:
  test-builds:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # Platform services
          - name: platform-api
            context: ./platform
            dockerfile: ./platform/Dockerfile
            build-args: SERVICE_NAME=platform-api
          - name: auth-service
            context: ./platform
            dockerfile: ./platform/Dockerfile
            build-args: SERVICE_NAME=auth-service
          - name: storage-service
            context: ./platform
            dockerfile: ./platform/Dockerfile
            build-args: SERVICE_NAME=storage-service
          - name: migrations-runner
            context: ./platform
            dockerfile: ./platform/Dockerfile
            build-args: SERVICE_NAME=migrations-runner
          # Infrastructure services
          - name: pgbouncer
            context: ./infrastructure/pgbouncer
            dockerfile: ./infrastructure/pgbouncer/Dockerfile
            build-args: ""
          - name: postgrest
            context: ./infrastructure/postgrest
            dockerfile: ./infrastructure/postgrest/Dockerfile
            build-args: ""
          - name: postgrest-manager
            context: ./infrastructure/postgrest-manager
            dockerfile: ./infrastructure/postgrest-manager/Dockerfile
            build-args: ""
          - name: backup
            context: ./infrastructure/backup
            dockerfile: ./infrastructure/backup/Dockerfile
            build-args: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: false
          tags: abushadaf/launchdb-${{ matrix.name }}:test
          build-args: ${{ matrix.build-args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-compose-test:
    runs-on: ubuntu-latest
    needs: test-builds

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test .env file
        run: |
          cat > .env << 'EOF'
          # Test environment
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=testpassword123
          POSTGRES_DB=platform

          PLATFORM_JWT_SECRET=test-jwt-secret-for-ci-only
          LAUNCHDB_MASTER_KEY=test-master-key-for-ci-only
          INTERNAL_API_KEY=test-internal-key-for-ci

          DOMAIN=localhost
          CORS_ORIGIN=http://localhost:3000

          HOST_SCRIPT_DIR=${{ github.workspace }}/infrastructure/scripts
          HOST_CONFIG_DIR=${{ github.workspace }}/infrastructure/postgrest/projects
          EOF

      - name: Validate docker-compose config
        run: docker compose config

      - name: Build all services
        run: docker compose build

      - name: Start core services
        run: |
          docker compose up -d postgres
          sleep 10
          docker compose up -d pgbouncer
          sleep 5

      - name: Check postgres health
        run: |
          docker compose ps
          docker compose logs postgres | tail -20

      - name: Cleanup
        if: always()
        run: docker compose down -v
