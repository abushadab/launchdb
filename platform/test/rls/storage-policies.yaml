# Storage RLS Integration Tests
# Tests existing RLS policies from migrations (no DDL needed)
# Uses valid UUID format for owner IDs

tests:
  - description: "Objects RLS isolation"
    # Tests existing objects_select_own, objects_update_own, objects_delete_own policies
    asserts:
      - action: SELECT
        as: { role: authenticated, sub: "11111111-1111-1111-1111-111111111111" }
        from: storage.objects
        where: "owner_id = '22222222-2222-2222-2222-222222222222'"
        expect: empty
        comment: "RLS filters out other users' objects"

      - action: UPDATE
        as: { role: authenticated, sub: "11111111-1111-1111-1111-111111111111" }
        table: storage.objects
        set: { size: 2048 }
        where: "owner_id = '22222222-2222-2222-2222-222222222222'"
        expect: success
        rows_affected: 0
        comment: "RLS prevents updating other users' objects"

      - action: DELETE
        as: { role: authenticated, sub: "11111111-1111-1111-1111-111111111111" }
        from: storage.objects
        where: "owner_id = '22222222-2222-2222-2222-222222222222'"
        expect: success
        rows_affected: 0
        comment: "RLS prevents deleting other users' objects"

  - description: "Buckets SELECT policy"
    # Tests existing buckets_select_all policy - all authenticated users can see buckets
    asserts:
      - action: SELECT
        as: { role: authenticated, sub: "11111111-1111-1111-1111-111111111111" }
        from: storage.buckets
        expect: empty
        comment: "Authenticated user can query buckets (empty is OK if no buckets exist)"

  - description: "Anon role storage access"
    # Tests anon role restrictions
    asserts:
      - action: SELECT
        as: { role: anon }
        from: storage.objects
        expect: empty
        comment: "Anon cannot see private objects"

      - action: SELECT
        as: { role: anon }
        from: storage.buckets
        expect: empty
        comment: "Anon cannot see buckets"
