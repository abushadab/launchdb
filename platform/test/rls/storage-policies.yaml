# Storage RLS Integration Tests
# Tests existing RLS policies from migrations with seeded test data
#
# Test UUIDs (seeded by rls-test-runner.ts):
#   USER1: 00000000-0000-0000-0000-000000000001
#   USER2: 00000000-0000-0000-0000-000000000002
#
# Seeded data:
#   - public-bucket (public, owner: USER1)
#   - private-bucket (private, owner: USER1)
#   - pub/user1.txt in public-bucket (owner: USER1)
#   - priv/user1.txt in private-bucket (owner: USER1)
#   - priv/user2.txt in private-bucket (owner: USER2)

tests:
  - description: "User1 can SELECT own objects"
    asserts:
      - action: SELECT
        as: { role: authenticated, sub: "00000000-0000-0000-0000-000000000001" }
        from: storage.objects
        where: "owner_id = '00000000-0000-0000-0000-000000000001'"
        expect: rows
        rows_count: 2
        comment: "User1 sees their 2 objects (pub/user1.txt, priv/user1.txt)"

  - description: "User1 CANNOT see User2's objects"
    asserts:
      - action: SELECT
        as: { role: authenticated, sub: "00000000-0000-0000-0000-000000000001" }
        from: storage.objects
        where: "owner_id = '00000000-0000-0000-0000-000000000002'"
        expect: empty
        comment: "RLS filters out User2's objects from User1"

  - description: "User2 can SELECT own objects"
    asserts:
      - action: SELECT
        as: { role: authenticated, sub: "00000000-0000-0000-0000-000000000002" }
        from: storage.objects
        where: "owner_id = '00000000-0000-0000-0000-000000000002'"
        expect: rows
        rows_count: 1
        comment: "User2 sees their 1 object (priv/user2.txt)"

  - description: "User1 can UPDATE own objects"
    asserts:
      - action: UPDATE
        as: { role: authenticated, sub: "00000000-0000-0000-0000-000000000001" }
        table: storage.objects
        set: { size: 999 }
        where: "owner_id = '00000000-0000-0000-0000-000000000001'"
        expect: success
        rows_affected: 2
        comment: "User1 can update their own 2 objects"

  - description: "User1 CANNOT update User2's objects"
    asserts:
      - action: UPDATE
        as: { role: authenticated, sub: "00000000-0000-0000-0000-000000000001" }
        table: storage.objects
        set: { size: 2048 }
        where: "owner_id = '00000000-0000-0000-0000-000000000002'"
        expect: success
        rows_affected: 0
        comment: "RLS prevents User1 updating User2's objects (0 rows affected)"

  - description: "User1 CANNOT delete User2's objects"
    asserts:
      - action: DELETE
        as: { role: authenticated, sub: "00000000-0000-0000-0000-000000000001" }
        from: storage.objects
        where: "owner_id = '00000000-0000-0000-0000-000000000002'"
        expect: success
        rows_affected: 0
        comment: "RLS prevents User1 deleting User2's objects (0 rows affected)"

  - description: "Authenticated users can SELECT buckets"
    asserts:
      - action: SELECT
        as: { role: authenticated, sub: "00000000-0000-0000-0000-000000000001" }
        from: storage.buckets
        expect: rows
        rows_count: 2
        comment: "User1 can see all buckets (public and private)"

      - action: SELECT
        as: { role: authenticated, sub: "00000000-0000-0000-0000-000000000002" }
        from: storage.buckets
        expect: rows
        rows_count: 2
        comment: "User2 can also see all buckets"

  - description: "Anon role can see public content"
    asserts:
      - action: SELECT
        as: { role: anon }
        from: storage.objects
        where: "bucket = 'public-bucket'"
        expect: rows
        rows_count: 1
        comment: "Anon can see objects in public buckets"

      - action: SELECT
        as: { role: anon }
        from: storage.objects
        where: "bucket = 'private-bucket'"
        expect: empty
        comment: "Anon cannot see objects in private buckets"

      - action: SELECT
        as: { role: anon }
        from: storage.buckets
        expect: rows
        rows_count: 2
        comment: "Anon can see bucket metadata"
