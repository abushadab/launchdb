# Auth RLS Integration Tests
# Tests existing RLS policies from migrations (no DDL needed)
# Uses valid UUID format for user IDs

tests:
  - description: "Authenticated user RLS isolation"
    # Tests existing users_select_own policy
    # Uses fake UUIDs - RLS should filter them out regardless of whether they exist
    asserts:
      - action: SELECT
        as: { role: authenticated, sub: "11111111-1111-1111-1111-111111111111" }
        from: auth.users
        where: "id = '22222222-2222-2222-2222-222222222222'"
        expect: empty
        comment: "RLS prevents seeing other users' records"

      - action: UPDATE
        as: { role: authenticated, sub: "11111111-1111-1111-1111-111111111111" }
        table: auth.users
        set: { email_verified: true }
        where: "id = '22222222-2222-2222-2222-222222222222'"
        expect: success
        rows_affected: 0
        comment: "RLS prevents updating other users' records"

  - description: "Sessions RLS isolation"
    # Tests existing sessions_select_own policy
    asserts:
      - action: SELECT
        as: { role: authenticated, sub: "11111111-1111-1111-1111-111111111111" }
        from: auth.sessions
        where: "user_id = '22222222-2222-2222-2222-222222222222'"
        expect: empty
        comment: "RLS filters out other users' sessions"

  - description: "Anon role cannot access auth tables"
    # Tests that anon role is blocked by existing policies
    asserts:
      - action: SELECT
        as: { role: anon }
        from: auth.users
        expect: empty
        comment: "Anon cannot see any users"

      - action: SELECT
        as: { role: anon }
        from: auth.sessions
        expect: empty
        comment: "Anon cannot see any sessions"

      - action: SELECT
        as: { role: anon }
        from: auth.refresh_tokens
        expect: empty
        comment: "Anon cannot see any tokens"
